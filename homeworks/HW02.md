# Домашнее задание

### MongoDB

### Цель:
В результате выполнения ДЗ вы научитесь разворачивать MongoDB, заполнять данными и делать запросы.


### Описание/Пошаговая инструкция выполнения домашнего задания:
Необходимо:
- установить MongoDB одним из способов: ВМ, докер;
- заполнить данными;
- написать несколько запросов на выборку и обновление данных

Сдача ДЗ осуществляется в виде миниотчета.

Задание повышенной сложности*
- создать индексы и сравнить производительность.


### Критерии оценки:

- Задание выполнено - 10 баллов
- Предложено красивое решение - плюс 2 балла
- Выполнено задание со* - плюс 5 баллов
- Минимальный порог: 10 баллов


# Отчет

### Установка MongoDB

Установка производится через docker-compose [файл](../mongodb/docker-compose.yaml). Кроме контейнера с Mongodb поднимается контейнер с mongo-compass для GUI доступа к бд.

```sh
docker-compose -f mongodb/docker-compose.yaml up -d
```

### Импорт данных

Данные для базы находятся в директории `mongodb/data/sample_meflix` в формате json-файлов. Импорт данных в базу производится через запуск [скрипта](../mongodb/import_data.sh) `mongodb/import_data.sh`

```sh
mongodb/import_data.sh
```

### Запросы

1. Найти и посчитать все фильмы по книгам Толкина в базе
    ```sh
    db.movies.find({writers: 'J.R.R. Tolkien (novel)'}).count()
    ```

    Результат:
    ```sh
    8
    ```


2. Найти фильм 2001 года по книге Толкина

    ```sh
    db.movies.find({$and: [{writers: 'J.R.R. Tolkien (novel)'}, {year: 2001}]})
    ```

    Результат:
    ```json
    [
        {
            _id: ObjectId('573a139af29313caabcf0f07'),
            fullplot: 'An ancient Ring thought lost for centuries has been found, and through a strange twist in fate has been given to a small Hobbit named Frodo. When Gandalf discovers the Ring is in fact the One Ring of the Dark Lord Sauron, Frodo must make an epic quest to the Cracks of Doom in order to destroy it! However he does not go alone. He is joined by Gandalf, Legolas the elf, Gimli the Dwarf, Aragorn, Boromir and his three Hobbit friends Merry, Pippin and Samwise. Through mountains, snow, darkness, forests, rivers and plains, facing evil and danger at every corner the Fellowship of the Ring must go. Their quest to destroy the One Ring is the only hope for the end of the Dark Lords reign!',
            imdb: { rating: 8.8, votes: 1109724, id: 120737 },
            year: 2001,
            plot: 'A meek hobbit of the Shire and eight companions set out on a journey to Mount Doom to destroy the One Ring and the dark lord Sauron.',
            genres: [ 'Adventure', 'Fantasy' ],
            rated: 'PG-13',
            metacritic: 92,
            title: 'The Lord of the Rings: The Fellowship of the Ring',
            lastupdated: '2015-08-31 00:05:39.967000000',
            languages: [ 'English', 'Sindarin' ],
            writers: [
            'J.R.R. Tolkien (novel)',
            'Fran Walsh (screenplay)',
            'Philippa Boyens (screenplay)',
            'Peter Jackson (screenplay)'
            ],
            type: 'movie',
            tomatoes: {
            website: 'http://www.lordoftherings.net/film/trilogy/thefellowship.html',
            viewer: { rating: 4.1, numReviews: 1348869, meter: 95 },
            dvd: ISODate('2002-08-06T00:00:00.000Z'),
            critic: { rating: 8.2, numReviews: 225, meter: 91 },
            boxOffice: '$313.8M',
            consensus: "Full of eye-popping special effects, and featuring a pitch-perfect cast, The Lord of the Rings: The Fellowship of the Ring brings J.R.R. Tolkien's classic to vivid life.",
            rotten: 20,
            production: 'New Line Cinema',
            lastUpdated: ISODate('2015-09-12T17:56:50.000Z'),
            fresh: 205
            },
            poster: 'https://m.media-amazon.com/images/M/MV5BN2EyZjM3NzUtNWUzMi00MTgxLWI0NTctMzY4M2VlOTdjZWRiXkEyXkFqcGdeQXVyNDUzOTQ5MjY@._V1_SY1000_SX677_AL_.jpg',
            num_mflix_comments: 381,
            released: ISODate('2001-12-19T00:00:00.000Z'),
            awards: {
            wins: 114,
            nominations: 100,
            text: 'Won 4 Oscars. Another 110 wins & 100 nominations.'
            },
            countries: [ 'New Zealand', 'USA' ],
            cast: [ 'Alan Howard', 'Noel Appleby', 'Sean Astin', 'Sala Baker' ],
            directors: [ 'Peter Jackson' ],
            runtime: 178
        }
    ]

3. Агрегация. Вывести фильм 2001 по книге Толкина и комментарии к нему с избранными полями
    ```sh
    db.movies.aggregate(
        [
            {
                $match: {
                    writers: 'J.R.R. Tolkien (novel)',
                    year: 2001
                }
            },
            {
                $lookup: {
                    from: "comments",
                    localField: "_id",
                    foreignField: "movie_id",
                    as: "comments"
                }
            },
            {
                $project: {
                    _id: "$_id",
                    year: "$year",
                    writers: "$writers",
                    cast: "$cast",
                    comments: "$comments"
                }
            }
        ]
    )
    ```

    Результат:
    ```json
    [
        {
            _id: ObjectId('573a139af29313caabcf0f07'),
            year: 2001,
            writers: [
                'J.R.R. Tolkien (novel)',
                'Fran Walsh (screenplay)',
                'Philippa Boyens (screenplay)',
                'Peter Jackson (screenplay)'
            ],
            cast: [ 'Alan Howard', 'Noel Appleby', 'Sean Astin', 'Sala Baker' ],
            comments: [
            {
                _id: ObjectId('5a9427648b0beebeb6963996'),
                name: 'Alliser Thorne',
                email: 'owen_teale@gameofthron.es',
                movie_id: ObjectId('573a139af29313caabcf0f07'),
                text: 'Quidem saepe nobis occaecati nisi nesciunt. Eveniet non animi iste accusantium dicta. Facilis sit corrupti fuga ipsam.',
                date: ISODate('1971-10-14T22:33:36.000Z')
            },
            {
                _id: ObjectId('5a9427648b0beebeb696399a'),
                name: 'Alliser Thorne',
                email: 'owen_teale@gameofthron.es',
                movie_id: ObjectId('573a139af29313caabcf0f07'),
                text: 'Harum eum nisi earum a. Maiores autem magni excepturi occaecati magnam iusto beatae. Harum magni nisi eius. Aut earum optio ratione ad ea quam veniam.',
                date: ISODate('1997-07-29T20:29:51.000Z')
            },
            {
                _id: ObjectId('5a9427648b0beebeb696399b'),
                name: 'Amy Ramirez',
                email: 'amy_ramirez@fakegmail.com',
                movie_id: ObjectId('573a139af29313caabcf0f07'),
                text: 'Amet quaerat laudantium commodi earum earum nemo maxime. Delectus consequuntur eius in quae. Doloribus aliquam reprehenderit corrupti modi.',
                date: ISODate('1970-05-16T15:00:16.000Z')
            },
            ]
        }
    ]
    ```


4. Удалить фильмы 1911 года
    ```sh
    db.movies.deleteMany({year: 1911})
    ```

    Результат:
    ```json
    { acknowledged: true, deletedCount: 2 }
    ```

5. Посмотреть сколько фильмов с годом выхода 2000 и новее
    ```sh
    db.movies.find({year: {$gte: 2000}}).count()
    ```

    Результат:
    ```json
    13721
    ```


### Индексы

На примере запроса фильмов 2001 года
```sh
db.movies.find({year: 2001})
```

Без индекса

```sh
db.movies.find({year: 2001}).explain("executionStats")
```

```json
executionStats: {
    executionSuccess: true,
    nReturned: 645,
    executionTimeMillis: 27,
    totalKeysExamined: 0,
    totalDocsExamined: 23537,
    executionStages: {
      isCached: false,
      stage: 'COLLSCAN',
      filter: { year: { '$eq': 2001 } },
      nReturned: 645,
      executionTimeMillisEstimate: 24,
      works: 23538,
      advanced: 645,
      needTime: 22892,
      needYield: 0,
      saveState: 2,
      restoreState: 2,
      isEOF: 1,
      direction: 'forward',
      docsExamined: 23537
    }
  }
```

Добавляем индекс

```sh
db.movies.createIndex({year: 1})
```

```sh
db.movies.find({year: 2001}).explain("executionStats")
```

```json
executionStats: {
    executionSuccess: true,
    nReturned: 645,
    executionTimeMillis: 6,
    totalKeysExamined: 645,
    totalDocsExamined: 645,
    executionStages: {
      isCached: false,
      stage: 'FETCH',
      nReturned: 645,
      executionTimeMillisEstimate: 0,
      works: 646,
      advanced: 645,
      needTime: 0,
      needYield: 0,
      saveState: 0,
      restoreState: 0,
      isEOF: 1,
      docsExamined: 645,
      alreadyHasObj: 0,
      inputStage: {
        stage: 'IXSCAN',
        nReturned: 645,
        executionTimeMillisEstimate: 0,
        works: 646,
        advanced: 645,
        needTime: 0,
        needYield: 0,
        saveState: 0,
        restoreState: 0,
        isEOF: 1,
        keyPattern: { year: 1 },
        indexName: 'year_1',
        isMultiKey: false,
        multiKeyPaths: { year: [] },
        isUnique: false,
        isSparse: false,
        isPartial: false,
        indexVersion: 2,
        direction: 'forward',
        indexBounds: { year: [ '[2001, 2001]' ] },
        keysExamined: 645,
        seeks: 1,
        dupsTested: 0,
        dupsDropped: 0
      }
    }
  }
```


|                             | без индекса | с индексом |
| --------------------------- | ------------|----------- |
|     executionTimeMillis     | 27          | 6          |
| docsExamined                | 23537       |            |
| keysExamined                |             | 645        |



Удаляем индекс после сравнения времени выполнения запроса и количества просмотренных записей

```sh
db.movies.dropIndex("year_1")
```

```json
{ nIndexesWas: 2, ok: 1 }
```
